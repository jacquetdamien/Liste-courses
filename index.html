<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Liste de courses</title>
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root{
      --bg:#f6f6f7; --card:#fff; --ink:#111; --muted:#6b6b6f; --line:#e7e7ea;
      --shadow: 0 10px 24px rgba(0,0,0,.08);
      --radius: 16px; --tap: 46px;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--ink); }
    .safe{ padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom); }
    header{
      position: sticky; top:0; z-index:10;
      background: rgba(246,246,247,.92); backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .bar{ display:flex; gap:10px; align-items:center; justify-content:space-between; padding:10px 14px; }
    .title{ display:flex; flex-direction:column; gap:2px; min-width:160px; }
    h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .meta{ margin:0; font-size:12px; color:var(--muted); }
    .row2{ display:flex; gap:10px; padding: 0 14px 12px; }
    .search{
      flex:1 1 auto; border:1px solid var(--line); border-radius:14px; background:var(--card);
      padding:10px 12px; min-height: var(--tap); display:flex; align-items:center; gap:10px;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    .search input{ width:100%; border:none; outline:none; font-size:15px; background:transparent; }
    .btn{
      border:1px solid var(--line); background:var(--card);
      border-radius:12px; padding:10px 12px; font-size:13px; min-height: var(--tap);
      display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none;
    }
    .btn:active{ transform: scale(.99); }
    .btn.danger{ border-color:#f1caca; }
    main{ padding:12px 14px 18px; max-width: 820px; margin:0 auto; }
    .sectionTitle{ margin: 14px 2px 10px; font-size:12px; letter-spacing:.8px; text-transform:uppercase; color:var(--muted); }
    .card{
      background:var(--card); border:1px solid var(--line); border-radius: var(--radius);
      box-shadow: var(--shadow); overflow:hidden; margin-bottom: 12px;
    }
    .cardHeader{
      padding: 12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
    }
    .catTitle{ margin:0; font-size:13px; letter-spacing:.8px; text-transform:uppercase; }
    .catSub{ margin:2px 0 0; font-size:12px; color:var(--muted); }
    .items{ list-style:none; margin:0; padding: 6px 6px 8px; }
    .item{
      display:flex; align-items:center; gap:10px;
      padding: 10px 10px; min-height: var(--tap);
      border-radius: 14px;
    }
    .item + .item{ border-top: 1px solid rgba(231,231,234,.55); border-top-left-radius:0; border-top-right-radius:0; }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line); border-radius:999px; padding:6px 10px;
      min-height: 34px; display:inline-flex; align-items:center;
    }
    .name{ font-size:16px; line-height:1.2; flex:1 1 auto; }
    .muted{ color:var(--muted); }
    .tapHint{ font-size:12px; color:var(--muted); padding: 8px 14px 12px; }
    .smallBtn{ font-size:12px; padding:8px 10px; border-radius:12px; min-height: 38px; }
    .toast{
      position: fixed; left: 50%; bottom: calc(env(safe-area-inset-bottom) + 16px);
      transform: translateX(-50%);
      background: rgba(17,17,17,.92); color:#fff; padding: 10px 12px; border-radius: 999px;
      font-size: 13px; opacity:0; pointer-events:none; transition: opacity .2s ease;
    }
    .toast.show{ opacity:1; }
    details > summary{
      list-style:none; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    details > summary::-webkit-details-marker{ display:none; }
  </style>
</head>

<body>
<header class="safe">
  <div class="bar">
    <div class="title">
      <h1>Liste de courses</h1>
      <p class="meta" id="meta">Chargement‚Ä¶</p>
    </div>
    <button class="btn danger" id="btnReset">Reset</button>
  </div>

  <div class="row2">
    <div class="search" title="Rechercher">
      üîé <input id="q" type="search" placeholder="Rechercher (ex: tomates, dentifrice‚Ä¶)" autocomplete="off" />
    </div>
    <button class="btn" id="btnClearBought">Vider ‚ÄúAchet√©‚Äù</button>
  </div>
</header>

<main id="app" class="safe">
  <div class="sectionTitle">√Ä acheter</div>
  <div id="selected"></div>

  <div class="sectionTitle">Achet√© (tri√© par rayons)</div>
  <div id="bought"></div>

  <div class="sectionTitle">Catalogue</div>
  <div id="catalog"></div>
</main>

<div class="toast" id="toast">Sauvegard√©</div>

<script>
  // -----------------------------
  // Persistance
  // status: 0=neutre, 1=√† acheter, 2=achet√©
  // -----------------------------
  const LS_KEY = "courses_bring_like_v2";
  const state = loadState();

  function loadState(){
    try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveState(){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    toast("Sauvegard√©");
  }

  let toastT=null;
  function toast(msg){
    const el=document.getElementById("toast");
    el.textContent=msg;
    el.classList.add("show");
    clearTimeout(toastT);
    toastT=setTimeout(()=>el.classList.remove("show"), 650);
  }

  // -----------------------------
  // Donn√©es (JSON externe + fallback)
  // -----------------------------
  const FALLBACK_DATA = {
    schema_version: 1,
    store_aisle_order: ["droguerie","bazar","animalerie","hygi√®ne","liquides","ap√©ro","√©picerie","cr√®merie","charcuterie","fruits et l√©gumes","poissonnerie","boucherie","surgel√©s"],
    categories: []
  };

  async function loadData(){
    try{
      const r = await fetch("./grocery_data.json", { cache: "no-store" });
      if(!r.ok) throw new Error("fetch failed");
      return await r.json();
    }catch(e){
      return FALLBACK_DATA;
    }
  }

  // -----------------------------
  // Helpers
  // -----------------------------
  const app = {
    q: document.getElementById("q"),
    meta: document.getElementById("meta"),
    selected: document.getElementById("selected"),
    bought: document.getElementById("bought"),
    catalog: document.getElementById("catalog"),
  };

  function normalize(s){
    return (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();
  }
  function makeKey(catId, name){
    return ("i__" + catId + "__" + name).toLowerCase().replace(/\s+/g,"_");
  }
  function getItemState(key){
    const it = state[key] || {};
    return { status: (it.status ?? 0), name: it.name, catId: it.catId };
  }
  function setItemState(key, patch){
    state[key] = state[key] || {};
    Object.assign(state[key], patch);
    saveState();
  }

  function groupByCategory(keys, catOrder){
    const map = new Map(catOrder.map(id => [id, []]));
    keys.forEach(k=>{
      const it = state[k];
      if(!it) return;
      if(!map.has(it.catId)) map.set(it.catId, []);
      map.get(it.catId).push(k);
    });
    // Keep order
    return catOrder.map(id => [id, map.get(id) || []]).filter(([,arr])=>arr.length>0);
  }

  function categoryTitleById(data){
    const m = new Map();
    data.categories.forEach(c => m.set(c.id, c.title));
    return m;
  }

  // -----------------------------
  // Rendu
  // -----------------------------
  function renderSelected(data){
    const titleMap = categoryTitleById(data);

    const selectedKeys = Object.keys(state).filter(k => state[k]?.status === 1);
    if(selectedKeys.length === 0){
      app.selected.innerHTML = `
        <div class="card">
          <div class="tapHint">Tape un article dans le <b>Catalogue</b> pour l‚Äôajouter ici. Re-tape ici pour le passer en <b>Achet√©</b>.</div>
        </div>`;
      return;
    }

    const groups = groupByCategory(selectedKeys, data.store_aisle_order);
    app.selected.innerHTML = groups.map(([catId, keys]) => {
      const catTitle = titleMap.get(catId) || catId;
      const lis = keys
        .sort((a,b)=> (state[a].name||"").localeCompare(state[b].name||"", "fr"))
        .map(k => {
          const name = state[k].name;
          return `
            <li class="item" data-key="${k}" data-action="markBought">
              <span class="pill">${catTitle}</span>
              <span class="name">${escapeHtml(name)}</span>
              <span class="muted">‚Üí Achet√©</span>
            </li>`;
        }).join("");
      return `
        <div class="card">
          <div class="cardHeader">
            <div>
              <p class="catTitle">${escapeHtml(catTitle)}</p>
              <p class="catSub">${keys.length} article(s)</p>
            </div>
          </div>
          <ul class="items">${lis}</ul>
        </div>`;
    }).join("");
  }

  function renderBought(data){
    const titleMap = categoryTitleById(data);

    const boughtKeys = Object.keys(state).filter(k => state[k]?.status === 2);
    if(boughtKeys.length === 0){
      app.bought.innerHTML = `
        <div class="card">
          <div class="tapHint">Les articles pass√©s en <b>Achet√©</b> apparaissent ici, tri√©s par tes rayons.</div>
        </div>`;
      return;
    }

    const groups = groupByCategory(boughtKeys, data.store_aisle_order);
    app.bought.innerHTML = groups.map(([catId, keys]) => {
      const catTitle = titleMap.get(catId) || catId;
      const lis = keys
        .sort((a,b)=> (state[a].name||"").localeCompare(state[b].name||"", "fr"))
        .map(k => {
          const name = state[k].name;
          return `
            <li class="item" data-key="${k}" data-action="unbuy">
              <span class="pill">${catTitle}</span>
              <span class="name muted" style="text-decoration:line-through;">${escapeHtml(name)}</span>
              <span class="muted">‚Ü©Ô∏é</span>
            </li>`;
        }).join("");

      return `
        <div class="card">
          <div class="cardHeader">
            <div>
              <p class="catTitle">${escapeHtml(catTitle)}</p>
              <p class="catSub">${keys.length} achet√©(s)</p>
            </div>
          </div>
          <ul class="items">${lis}</ul>
        </div>`;
    }).join("");
  }

  function renderCatalog(data){
    const q = normalize(app.q.value);
    const titleMap = categoryTitleById(data);

    // Sort categories in store order (and append any unknown at end)
    const byId = new Map(data.categories.map(c => [c.id, c]));
    const orderedCats = [
      ...data.store_aisle_order.filter(id => byId.has(id)).map(id => byId.get(id)),
      ...data.categories.filter(c => !data.store_aisle_order.includes(c.id))
    ];

    app.catalog.innerHTML = orderedCats.map(cat => {
      const items = cat.items || [];
      const lines = items.map(name => {
        const key = makeKey(cat.id, name);
        // ensure we store metadata at least once (for grouping)
        if(!state[key]) state[key] = { status: 0, name, catId: cat.id };

        const st = getItemState(key).status;
        const badge = st === 1 ? "‚Ä¢ √Ä acheter" : (st === 2 ? "‚úì Achet√©" : "");
        const visible = !q || normalize(name).includes(q);

        if(!visible) return "";

        return `
          <li class="item" data-key="${key}" data-action="toggleSelect">
            <span class="name">${escapeHtml(name)} <span class="muted">${escapeHtml(badge)}</span></span>
          </li>`;
      }).join("");

      if(!lines.trim()) return "";

      const countSelected = Object.keys(state).filter(k => state[k]?.catId === cat.id && state[k]?.status === 1).length;

      return `
        <div class="card">
          <div class="cardHeader">
            <details open>
              <summary>
                <div>
                  <p class="catTitle">${escapeHtml(cat.title || titleMap.get(cat.id) || cat.id)}</p>
                  <p class="catSub">${countSelected ? countSelected + " √† acheter" : "‚Äî"}</p>
                </div>
                <span class="muted">‚ñº</span>
              </summary>
              <div class="tapHint">Tap = ajouter/enlever ‚Äú√Ä acheter‚Äù.</div>
            </details>
          </div>
          <ul class="items">${lines}</ul>
        </div>`;
    }).join("");
  }

  function renderAll(data){
    // Clean meta
    app.meta.textContent = "Sauvegarde locale activ√©e ‚Ä¢ mode Bring-like";
    renderSelected(data);
    renderBought(data);
    renderCatalog(data);
  }

  // -----------------------------
  // Actions (tap anywhere on item rows)
  // -----------------------------
  function handleTap(e, data){
    const li = e.target.closest(".item");
    if(!li) return;
    const key = li.getAttribute("data-key");
    const action = li.getAttribute("data-action");
    if(!key || !action) return;

    if(action === "toggleSelect"){
      const cur = getItemState(key).status;
      // 0->1 (√† acheter), 1->0 (retire), 2->1 (r√©-acheter)
      const next = (cur === 0) ? 1 : (cur === 1 ? 0 : 1);
      setItemState(key, { status: next });
      renderAll(data);
      return;
    }

    if(action === "markBought"){
      setItemState(key, { status: 2 });
      renderAll(data);
      return;
    }

    if(action === "unbuy"){
      setItemState(key, { status: 1 });
      renderAll(data);
      return;
    }
  }

  // HTML escaping
  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // -----------------------------
  // Boot
  // -----------------------------
  (async function(){
    const data = await loadData();

    // Ensure every known item is in state with metadata
    for(const cat of (data.categories || [])){
      for(const name of (cat.items || [])){
        const key = makeKey(cat.id, name);
        if(!state[key]) state[key] = { status: 0, name, catId: cat.id };
        else {
          // keep existing status, just ensure metadata
          state[key].name = state[key].name || name;
          state[key].catId = state[key].catId || cat.id;
        }
      }
    }
    saveState(); // store any metadata back once

    renderAll(data);

    app.q.addEventListener("input", ()=>renderAll(data));
    document.getElementById("btnReset").addEventListener("click", ()=>{
      localStorage.removeItem(LS_KEY);
      // Hard reload state
      for(const k of Object.keys(state)) delete state[k];
      toast("R√©initialis√©");
      renderAll(data);
    });
    document.getElementById("btnClearBought").addEventListener("click", ()=>{
      Object.keys(state).forEach(k => { if(state[k]?.status === 2) state[k].status = 0; });
      saveState();
      renderAll(data);
    });

    document.body.addEventListener("click", (e)=>handleTap(e, data));
  })();
</script>
</body>
</html>

